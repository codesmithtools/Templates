<%------------------------------------------------------------------------------------------
* Author: Eric J. Smith
* Description: This template will generate wrappers for a stored procedure in a database.
------------------------------------------------------------------------------------------%>
<%@ CodeTemplate Language="VB" TargetLanguage="VB" Inherits="CodeSmith.BaseTemplates.VBSqlCodeTemplate" Description="This template will generate wrappers for a stored procedure in a database." %>

<%-- Required Properties  --%>
<%@ Property Name="SourceCommand" Type="SchemaExplorer.CommandSchema" Category="Required" Description="Command that the wrapper class should wrap." IncludeFunctions="True" %>
<%@ Property Name="Accessibility" Type="AccessibilityEnum" Default="Public" Category="Required" Description="The accessibility of the generated classes." %>
<%@ Property Name="ResultSchema" Type="ResultSchemaEnum" Default="StronglyTyped" Category="Required" Description="Determines what type of result schema should be used for the wrapper class." %>
<%@ Property Name="TargetNamespace" Type="System.String" Category="Required" Description="Namespace that the generated classes should be a member of." %>

<%-- Optional Properties  --%>
<%@ Property Name="CommandClassName" Type="System.String" Optional="True" Category="Optional" Description="Used to override the name of the command wrapper class." %>
<%@ Property Name="ResultRowClassName" Type="System.String" Optional="True" Category="Optional" Description="Used to override the name of the result row class." %>
<%@ Property Name="CommandPrefix" Type="System.String" Default="usp_" Category="Optional" Description="If this prefix is found at the start of a command name, it will be stripped off." %>
<%@ Property Name="BatchMode" Type="System.Boolean" Default="False" Category="Optional" Description="If true, the template will not output using and namespace statements." %>

<%-- Register referenced assemblies.  --%>
<%@ Assembly Name="CodeSmith.BaseTemplates" %>
<%@ Assembly Name="CodeSmith.CustomProperties" %>
<%@ Assembly Name="SchemaExplorer" %>

<%-- Import commonly used namespaces. --%>
<%@ Import Namespace="SchemaExplorer" %>

<% If Not (BatchMode) Then %>
'------------------------------------------------------------------------------
' <autogenerated>
'     This code was generated by CodeSmith.
'
'     Version: <%= GetType(CodeTemplate).Assembly.GetName().Version.ToString() %>
'
'     Changes to this file may cause incorrect behavior AndAlso will be lost if
'     the code is regenerated.
' </autogenerated>
'------------------------------------------------------------------------------

Imports System
Imports System.Data
Imports System.Data.SqlClient
<% If (Me.ResultSchema = ResultSchemaEnum.StronglyTyped AndAlso Me.ReturnsResultSet) Then %>
Imports System.Collections.ObjectModel
<% End If %>

Namespace <%= TargetNamespace %>
<% End If %>

<% If (ResultSchema = ResultSchemaEnum.StronglyTyped AndAlso ReturnsResultSet) Then %>
	#Region "<%= GetRowClassName() %>"
	' <summary>
	' Stores result row level information from the <%= SourceCommand.Name %> stored procedure.
	' </summary>
	<Serializable()> _
	<%= GetAccessModifier() %> Class <%= GetRowClassName() %>
	
		#Region "Member Variables"
		
        <% For Each column As CommandResultColumnSchema In SourceCommand.CommandResults(0).Columns %>
		<%= GetMemberVariableDeclarationStatement(column) %>
		<% Next %>
		
        #End Region
		
		#Region "Constructors"
		
        Public Sub New()
		End Sub
		
		Public Sub New(reader As SqlDataReader)
			LoadFromReader(reader)
		End Sub
		
        #End Region
		
		#Region "Helper Methods"
		
        Protected Sub LoadFromReader(reader As SqlDataReader)
			If (Not reader Is Nothing AndAlso Not reader.IsClosed) Then
				<% For i as Int32 = 0 To (SourceCommand.CommandResults(0).Columns.Count - 1) %>
				<%= GetReaderAssignmentStatement(SourceCommand.CommandResults(0).Columns(i), i) %>
				<% Next %>
			End If
		End Sub
        
        ''' <summary>
        ''' Returns the Bytes stored in a binary column.
        ''' </summary>
        ''' <param name="reader">The reader.</param>
        ''' <param name="columnName">The column name.</param>
        ''' <returns>Bytes Stored in a column.</returns>
        Public Shared Function GetBytes(ByVal reader As SqlDataReader, ByVal columnName As String) As Byte()
            Dim buffer As Byte() = New Byte(1024) {}
            Dim fieldOffset As Long = 0
    
            Using stream As System.IO.MemoryStream = New System.IO.MemoryStream()
                Dim bytesRead As Integer = 0
    
                bytesRead = CInt(reader.GetBytes(columnName, fieldOffset, buffer, 0, buffer.Length))
                While bytesRead > 0
                    Dim actualRead As Byte() = New Byte(bytesRead) {}
                    Array.Copy(buffer, 0, actualRead, 0, bytesRead)
                    stream.Write(actualRead, 0, actualRead.Length)
                    fieldOffset += bytesRead
    
                    bytesRead = CInt(reader.GetBytes(columnName, fieldOffset, buffer, 0, buffer.Length))
                End While
    
                Return stream.ToArray()
            End Using
        End Function  
        
		#End Region
		
		#Region "Public Properties"
		<% For i as Int32 = 0 To (SourceCommand.CommandResults(0).Columns.Count - 1) %>
		Public Property <%= GetPropertyName(SourceCommand.CommandResults(0).Columns(i)) %> As <%= GetNativeType(SourceCommand.CommandResults(0).Columns(i)) %>
			Get
				Return <%= GetMemberVariableName(SourceCommand.CommandResults(0).Columns(i)) %>
			End Get
			Set
				<%= GetMemberVariableName(SourceCommand.CommandResults(0).Columns(i)) %> = value
			End Set
		End Property
		<% If (i < SourceCommand.CommandResults(0).Columns.Count - 1) Then Response.Write(vbNewLine) %>		
		<% Next %>
		#End Region
	End Class
	#End Region	
<% End If %>
	#Region "<%= SourceCommand.Name %> Wrapper"
    ' <summary>
    ' This class is a wrapper for the <%= SourceCommand.Name %> stored procedure.
    ' </summary>
    <%= GetAccessModifier() %> class <%= GetClassName() %>

		#Region "Member Variables
		
		Protected _connectionString As String = String.Empty
        Protected _connection As SqlConnection = Nothing
        Protected _transaction As SqlTransaction = Nothing
		Protected _ownsConnection As Boolean = true
		Protected _recordsAffected As Int32= -1
		Protected _returnValue As <%= GetReturnValueDataType() %>
		<% For Each parameter As ParameterSchema In SourceCommand.NonReturnValueParameters %>
		<%= GetMemberVariableDeclarationStatement(parameter) %>
		<% Next %>
		#End Region
		
		#Region "Constructors"
		Public Sub New()
		End Sub
		
		Public Sub New(connectionString As String)
			Me.ConnectionString = connectionString
		End Sub
		
		Public Sub New(connection As SqlConnection)
			Me.Connection = connection
		End Sub
		
		Public Sub New(connection As SqlConnection, transaction As SqlTransaction)
			Me.Connection = connection
			Me.Transaction = transaction
		End Sub
		
		#End Region
		
		#Region "Public Properties"
		' <summary>
		' The connection string to use when executing the <%= SourceCommand.Name %> stored procedure.
		' </summary>
		Public Property ConnectionString As String
			Get
				Return _connectionString
			End Get
			Set
				_connectionString = value
			End Set
		End Property
        
        ' <summary>
        ' The connection to use when executing the <%= SourceCommand.Name %> stored procedure.
        ' If this is not null, it will be used instead of creating a New connection.
        ' </summary>
        Public Property Connection As SqlConnection
            Get
				Return _connection
			End Get
            Set 
				_connection = value
			End Set
        End Property
		
        ' <summary>
        ' The transaction to use when executing the <%= SourceCommand.Name %> stored procedure.
        ' If this is not null, the stored procedure will be executing within the transaction.
        ' </summary>
        Public Property Transaction As SqlTransaction
            Get
				Return _transaction
			End Get
            Set
				_transaction = value
			End Set
        End Property
		
		' <summary>
		' Gets the Return value from the <%= SourceCommand.Name %> stored procedure.
		' </summary>
		Public ReadOnly Property ReturnValue As <%= GetReturnValueDataType() %>
			Get
				Return _returnValue
			End Get
		End Property
		
		' <summary>
		' Gets the number of rows changed, inserted, or deleted by execution of the <%= SourceCommand.Name %> stored procedure.
		' </summary>
		Public ReadOnly Property RecordsAffected As Int32
			Get
				Return _recordsAffected
			End Get
		End Property
		
		<% For i as Int32 = 0 To (SourceCommand.NonReturnValueParameters.Count - 1) %>
		' <summary>
		' <%= SourceCommand.NonReturnValueParameters(i).Description %>
		' </summary>
		Public Property <%= GetPropertyName(SourceCommand.NonReturnValueParameters(i)) %> As <%= GetNativeType(SourceCommand.NonReturnValueParameters(i)) %>
			Get
				Return <%= GetMemberVariableName(SourceCommand.NonReturnValueParameters(i)) %>
			End Get
			Set
				<%= GetMemberVariableName(SourceCommand.NonReturnValueParameters(i)) %> = value
			End Set
		End Property
		<% If (i < SourceCommand.NonReturnValueParameters.Count - 1) Then Response.Write(vbNewLine) %>		
		<% Next %>
		#End Region
		
		#Region "Helper Methods"
        
        Private Function GetConnection() As SqlConnection
            If (Not Connection Is Nothing) Then
				_ownsConnection = false
                Return Connection
            Else
 				System.Diagnostics.Debug.Assert(ConnectionString.Length <> 0, "You must first set the ConnectioString property before calling an Execute method.")
            	Return New SqlConnection(ConnectionString)
            End If
        End Function
	    
		#End Region
		
		#Region "Execute Methods"
		
        <% If (ReturnsResultSet) Then %>
		' <summary>
		' This method calls the <%= SourceCommand.Name %> stored procedure and returns a SqlDataReader with the results.
		' </summary>
		' <returns>SqlDataReader</returns>
		Public Overridable Function <%= IIf(ReturnsResultSet AndAlso ResultSchema = ResultSchemaEnum.ADO , "Execute" , "ExecuteReader") %>() As SqlDataReader

			Dim reader As SqlDataReader = Nothing
			Dim cmd As SqlCommand = New SqlCommand()
			Dim cn As SqlConnection = GetConnection()
			
			Try
				cmd.Connection = cn
				cmd.Transaction = Transaction
<% If Not(IsTableValuedFunction) Then %>
				cmd.CommandText = "[<%= SourceCommand.Owner %>].[<%= SourceCommand.Name %>]"
				cmd.CommandType = CommandType.StoredProcedure
<% Else %>
                cmd.CommandText = "SELECT * FROM [<%= SourceCommand.Owner %>].[<%= SourceCommand.Name %>](<%=BuildArgumentList()%>)"
				cmd.CommandType = CommandType.Text
<% End If %>
				
				'Populate Parameters
				Dim prmReturnValue As SqlParameter = cmd.Parameters.Add("@RETURN_VALUE", SqlDbType.Int)
				prmReturnValue.Direction = ParameterDirection.ReturnValue
				
				<% For i As Int32 = 0 To (SourceCommand.NonReturnValueParameters.Count - 1) %>
				Dim <%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %> As SqlParameter = cmd.Parameters.Add("<%= SourceCommand.NonReturnValueParameters(i).Name %>", SqlDbType.<%= GetSqlDbType(SourceCommand.NonReturnValueParameters(i).NativeType) %>)
				<% If (SourceCommand.NonReturnValueParameters(i).Direction <> ParameterDirection.Input) Then %>
				If (<%= GetMemberVariableName(SourceCommand.NonReturnValueParameters(i)) %><%=BuildNullValueStatement(SourceCommand.NonReturnValueParameters(i))%>) Then
				<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Direction = ParameterDirection.<%= SourceCommand.NonReturnValueParameters(i).Direction.ToString() %>
				Else
					<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Direction = ParameterDirection.Output
				End If
				<% Else %>
				<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Direction = ParameterDirection.<%= SourceCommand.NonReturnValueParameters(i).Direction.ToString() %>
				<% End If %>
				<% BuildParameterExtraStatements(SourceCommand.NonReturnValueParameters(i)) %>
				If (<%= BuildNullCheckStatement(SourceCommand.NonReturnValueParameters(i)) %>) Then
					<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Value = <%= GetPropertyName(SourceCommand.NonReturnValueParameters(i)) %><%=BuildNullValueStatement(SourceCommand.NonReturnValueParameters(i))%>
				Else
                    <%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Value = DBNull.Value
                End If
				<% If (i < SourceCommand.NonReturnValueParameters.Count - 1) Then Response.Write(vbTab + vbTab + vbTab + vbTab + vbNewLine) %>
				<% Next %>
				'End Populate Parameters
				
				'Execute Command
                If (cn.State <> ConnectionState.Open) Then cn.Open()
				If (_ownsConnection) Then
					reader = cmd.ExecuteReader(CommandBehavior.CloseConnection)
				Else
					reader = cmd.ExecuteReader()
				End If
				'End Execute Command
				
				'Get Output Parameters
				If (Not prmReturnValue.Value Is Nothing AndAlso Not prmReturnValue.Value Is DBNull.Value)
					_returnValue = CType(prmReturnValue.Value, <%= GetReturnValueDataType() %>)
				End If
				
				<% For i As Int32 = 0 To (SourceCommand.AllOutputParameters.Count - 1) %>
				If (Not <%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %> Not Is Nothing AndAlso <%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value Is Nothing) Then
					If (<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value is <%= GetNativeType(SourceCommand.AllOutputParameters(i)) %>) Then
						<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = (<%= GetNativeType(SourceCommand.AllOutputParameters(i)) %>)<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value
					Else
						If (<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value <> DBNull.Value)
							<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = New <%= GetNativeType(SourceCommand.AllOutputParameters(i)) %>((<%= GetCSharpVariableType(SourceCommand.AllOutputParameters(i).DataType) %>)<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value)
						Else
							<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = Nothing
						End If
					End If
				Else
					<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = Nothing
				End If}
				<% If (i < SourceCommand.AllOutputParameters.Count - 1) Then Response.Write(vbTab + vbTab + vbTab + vbTab + vbNewLine) %>
				<% Next %>
				'"End Get Output Parameters
			Finally
				cmd.Dispose()
			End Try
			
			Return reader
		End Function
		
		' <summary>
		' This method calls the <%= SourceCommand.Name %> stored procedure AndAlso returns a DataSet with the results.
		' </summary>
		' <returns>DataSet</returns>
		Public Overridable Function ExecuteDataSet() As DataSet

			Dim ds As DataSet = New DataSet()
			Dim cmd As SqlCommand = New SqlCommand()
			Dim cn As SqlConnection = GetConnection()
			
			Try
				cmd.Connection = cn
				cmd.Transaction = Transaction
<% If Not(IsTableValuedFunction) Then %>
				cmd.CommandText = "[<%= SourceCommand.Owner %>].[<%= SourceCommand.Name %>]"
				cmd.CommandType = CommandType.StoredProcedure
<% Else %>
                cmd.CommandText = "SELECT * FROM [<%= SourceCommand.Owner %>].[<%= SourceCommand.Name %>](<%=BuildArgumentList()%>)"
				cmd.CommandType = CommandType.Text
<% End If %>
				
				'Populate Parameters
				Dim prmReturnValue As SqlParameter = cmd.Parameters.Add("@RETURN_VALUE", SqlDbType.Int)
				prmReturnValue.Direction = ParameterDirection.ReturnValue
				
				<% For i As Int32 = 0 To (SourceCommand.NonReturnValueParameters.Count - 1) %>
				Dim <%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %> As SqlParameter = cmd.Parameters.Add("<%= SourceCommand.NonReturnValueParameters(i).Name %>", SqlDbType.<%= GetSqlDbType(SourceCommand.NonReturnValueParameters(i).NativeType) %>)
				<% If (SourceCommand.NonReturnValueParameters(i).Direction <> ParameterDirection.Input) Then %>
				If (<%= GetMemberVariableName(SourceCommand.NonReturnValueParameters(i)) %><%=BuildNullValueStatement(SourceCommand.NonReturnValueParameters(i))%>) Then
				<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Direction = ParameterDirection.<%= SourceCommand.NonReturnValueParameters(i).Direction.ToString() %>
				Else
					<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Direction = ParameterDirection.Output
				End If
				<% Else %>
				<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Direction = ParameterDirection.<%= SourceCommand.NonReturnValueParameters(i).Direction.ToString() %>
				<% End If %>
				<% BuildParameterExtraStatements(SourceCommand.NonReturnValueParameters(i)) %>
				If (<%= BuildNullCheckStatement(SourceCommand.NonReturnValueParameters(i)) %>) Then
					<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Value = <%= GetPropertyName(SourceCommand.NonReturnValueParameters(i)) %><%=BuildNullValueStatement(SourceCommand.NonReturnValueParameters(i))%>
				Else
                    <%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Value = DBNull.Value
                End If
				<% If (i < SourceCommand.NonReturnValueParameters.Count - 1) Then Response.Write(vbTab + vbTab + vbTab + vbTab + vbNewLine) %>
				<% Next %>
				'End Populate Parameters
				
				'Execute Command
				if (cn.State <> ConnectionState.Open) Then cn.Open()
				
				Dim da As SqlDataAdapter = New SqlDataAdapter(cmd)
				da.Fill(ds)
				_recordsAffected = ds.Tables(0).Rows.Count
				'End Execute Command
				
				'Get Output Parameters
				If (Not prmReturnValue.Value Is Nothing AndAlso Not prmReturnValue.Value Is DBNull.Value) Then
					_returnValue = CType(prmReturnValue.Value, <%= GetReturnValueDataType() %>)
				End If
				
				<% For i As Int32 = 0 To (SourceCommand.AllOutputParameters.Count - 1) %>
				If Not (<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %> Not Is Nothing AndAlso <%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value Is Nothing) Then
					If (<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value is <%= GetNativeType(SourceCommand.AllOutputParameters(i)) %>) Then
						<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = (<%= GetNativeType(SourceCommand.AllOutputParameters(i)) %>)<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value
					Else
						If (<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value <> DBNull.Value) Then
							<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = New <%= GetNativeType(SourceCommand.AllOutputParameters(i)) %>((<%= GetCSharpVariableType(SourceCommand.AllOutputParameters(i).DataType) %>)<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value)
						Else
							<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = Nothing
						End If
					End If
				Else
					<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = Nothing
				End If
				<% If (i < SourceCommand.AllOutputParameters.Count - 1) Then Response.Write(vbTab + vbTab + vbTab + vbTab + vbNewLine) %>
				<% Next %>
				'End Get Output Parameters
			Finally
				If (_ownsConnection) Then
					If (cn.State = ConnectionState.Open) Then
						cn.Close()
					End If
					
					cn.Dispose()
				End If
				cmd.Dispose()
			End Try
			
			Return ds
		End Function
		
		<% End If %>
		<% If (ReturnsResultSet = False OrElse ResultSchema = ResultSchemaEnum.StronglyTyped) Then %>
		' <summary>
		' This method calls the <%= SourceCommand.Name %> stored procedure<% If (ReturnsResultSet) Then %> AndAlso outputs the results to a custom strongly typed collection<% End If %>.
		' </summary>
		<% If (ReturnsResultSet) Then %>
		' <returns><%= GetRowClassCollectionName() %></returns>
		<% End If %>
		Public Overridable <% If (ReturnsResultSet) Then Response.Write("Function") Else Response.Write("Sub") %> Execute() <% If (ReturnsResultSet) Then Response.Write(" As " + GetRowClassCollectionName()) %>
			<% If (ReturnsResultSet) Then %>
			Dim <%= GetRowClassCollectionInstanceName() %> As <%= GetRowClassCollectionName() %> = New <%= GetRowClassCollectionName() %>()
			<% End If %>
			Dim cmd As SqlCommand= New SqlCommand()
			Dim cn As SqlConnection = GetConnection()
			
			Try
				cmd.Connection = cn
				cmd.Transaction = Transaction
<% If Not(IsTableValuedFunction) Then %>
				cmd.CommandText = "[<%= SourceCommand.Owner %>].[<%= SourceCommand.Name %>]"
				cmd.CommandType = CommandType.StoredProcedure
<% Else %>
                cmd.CommandText = "SELECT * FROM [<%= SourceCommand.Owner %>].[<%= SourceCommand.Name %>](<%=BuildArgumentList()%>)"
				cmd.CommandType = CommandType.Text
<% End If %>
				
				'Populate Parameters
				Dim prmReturnValue As SqlParameter = cmd.Parameters.Add("@RETURN_VALUE", SqlDbType.Int)
				prmReturnValue.Direction = ParameterDirection.ReturnValue
				
				<% For i As Int32 = 0 To (SourceCommand.NonReturnValueParameters.Count - 1) %>
				Dim <%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %> As SqlParameter = cmd.Parameters.Add("<%= SourceCommand.NonReturnValueParameters(i).Name %>", SqlDbType.<%= GetSqlDbType(SourceCommand.NonReturnValueParameters(i).NativeType) %>)
				<% If (SourceCommand.NonReturnValueParameters(i).Direction <> ParameterDirection.Input) Then %>
				If (<%= BuildNullCheckStatement(SourceCommand.NonReturnValueParameters(i)) %>) Then
				<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Direction = ParameterDirection.<%= SourceCommand.NonReturnValueParameters(i).Direction.ToString() %>
				Else
					<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Direction = ParameterDirection.Output
				End If
				<% Else %>
				<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Direction = ParameterDirection.<%= SourceCommand.NonReturnValueParameters(i).Direction.ToString() %>
				<% End If %>
				<% BuildParameterExtraStatements(SourceCommand.NonReturnValueParameters(i)) %>
				If (<%= BuildNullCheckStatement(SourceCommand.NonReturnValueParameters(i)) %>) Then
					<%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Value = <%= GetPropertyName(SourceCommand.NonReturnValueParameters(i)) %><%=BuildNullValueStatement(SourceCommand.NonReturnValueParameters(i))%>
				Else
                    <%= GetParameterName(SourceCommand.NonReturnValueParameters(i).Name) %>.Value = DBNull.Value
                End If
				<% If (i < SourceCommand.NonReturnValueParameters.Count - 1) Then Response.Write(vbTab + vbTab + vbTab + vbTab + vbNewLine) %>
				<% Next %>
				
				'Execute Command
				<% If (ReturnsResultSet) Then %>
				If (cn.State <> ConnectionState.Open) Then cn.Open()
				Dim reader As SqlDataReader = cmd.ExecuteReader()
				Try
					While (reader.Read())
						Dim <%= GetCamelCaseName(GetRowClassName()) %> As <%= GetRowClassName() %> = New <%= GetRowClassName() %>(reader)
						<%= GetRowClassCollectionInstanceName() %>.Add(<%= GetCamelCaseName(GetRowClassName()) %>)
					End While
				Finally
					If (Not reader.IsClosed) Then
						reader.Close()
						_recordsAffected = reader.RecordsAffected
					End If
				End Try
				<% Else %>
				If (cn.State <> ConnectionState.Open) Then cn.Open()
				_recordsAffected = cmd.ExecuteNonQuery()
				<% End If %>
				
				'Get Output Parameters
				If Not (prmReturnValue.Value Is Nothing AndAlso prmReturnValue.Value Is DBNull.Value) Then 
					_returnValue = CType(prmReturnValue.Value, <%= GetReturnValueDataType() %>)
				End If
				
				<% For i As Int32 = 0 To (SourceCommand.AllOutputParameters.Count - 1) %>
				If Not (<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %> Is Nothing AndAlso <%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value Is Nothing) Then
					If (TypeOf <%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value Is <%= GetNativeType(SourceCommand.AllOutputParameters(i)) %>) Then
						<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = <%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value
					Else
						If Not(<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value Is DBNull.Value)
							<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = New <%= GetNativeType(SourceCommand.AllOutputParameters(i)) %>(<%= GetParameterName(SourceCommand.AllOutputParameters(i).Name) %>.Value)
						Else
							<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = Nothing
						End If
					End If
				Else
					<%= GetPropertyName(SourceCommand.AllOutputParameters(i)) %> = Nothing
				End If
				<% If (i < SourceCommand.AllOutputParameters.Count - 1) Then Response.Write(vbTab + vbTab + vbTab + vbTab + vbNewLine) %>
				<% Next %>
				'End Get Output Parameters
			Finally
				If (_ownsConnection) Then
					If (cn.State = ConnectionState.Open) Then
						cn.Close()
					End If
					
					cn.Dispose()
				End If
				cmd.Dispose()
			End Try
			<% If (ReturnsResultSet) Then %>
			
			Return <%= GetRowClassCollectionInstanceName() %>
			<% End If %>
		End <% If (ReturnsResultSet) Then Response.Write("Function") Else Response.Write("Sub") %> 		
		<% End If %>
		
		<% If (SourceCommand.Parameters.Count <= 42) Then ' IntelliSense breaks after 42 parameters on one method. %>
		<% If (ReturnsResultSet) Then %>
		' <summary>
		' This method calls the <%= SourceCommand.Name %> stored procedure AndAlso returns a SqlDataReader with the results.
		' </summary>
		<% BuildXmlCommentParameterList() %>
		' <returns>SqlDataReader</returns>
		Public Shared Function <%= IIf(ReturnsResultSet AndAlso ResultSchema = ResultSchemaEnum.ADO , "Execute" , "ExecuteReader") %>(<%= BuildParameterList() %>) As SqlDataReader
			Dim <%= GetCamelCaseName(GetClassName()) %> As <%= GetClassName() %> = New <%= GetClassName() %>()
			
			'"Assign Property Values"
			<%= GetCamelCaseName(GetClassName()) %>.ConnectionString = connectionString
			<%= AssignPropertyValues(GetCamelCaseName(GetClassName())) %>
			'"End Assign Property Values"
			
			Dim reader As SqlDataReader = <%= GetCamelCaseName(GetClassName()) %>.<%= IIf(ReturnsResultSet AndAlso ResultSchema = ResultSchemaEnum.ADO , "Execute" , "ExecuteReader") %>()
			
			'"Get Property Values"
			<%= GetPropertyValues(GetCamelCaseName(GetClassName())) %>
			'"End Get Property Values"
			
			Return reader
		End Function
		
		' <summary>
		' This method calls the <%= SourceCommand.Name %> stored procedure AndAlso returns a DataSet with the results.
		' </summary>
		<% BuildXmlCommentParameterList() %>
		' <returns>DataSet</returns>
		Public Shared Function ExecuteDataSet(<%= BuildParameterList() %>) As DataSet
			Dim <%= GetCamelCaseName(GetClassName()) %> As <%= GetClassName() %> = New <%= GetClassName() %>()
			
			'"Assign Property Values
			<%= GetCamelCaseName(GetClassName()) %>.ConnectionString = connectionString
			<%= AssignPropertyValues(GetCamelCaseName(GetClassName())) %>
			'"End Assign Property Values
			
			Dim ds As DataSet = <%= GetCamelCaseName(GetClassName()) %>.ExecuteDataSet()
			
			'"Get Property Values
			<%= GetPropertyValues(GetCamelCaseName(GetClassName())) %>
			'"End Get Property Values
			
			Return ds
		End Function
		
		<% End If %>
		<% If (ReturnsResultSet = False OrElse ResultSchema = ResultSchemaEnum.StronglyTyped) Then %>
		' <summary>
		' This method calls the <%= SourceCommand.Name %> stored procedure<% If (ReturnsResultSet) Then %> AndAlso outputs the results to a custom strongly typed collection<% End If %>.
		' </summary>
		<% BuildXmlCommentParameterList() %>
		<% If (ReturnsResultSet) Then %>
		' <returns><%= GetRowClassCollectionName() %></returns>
		<% End If %>
		Public Shared <% If (ReturnsResultSet) Then Response.Write("Function") Else Response.Write("Sub") %> Execute(<%= BuildParameterList() %>) <% If (ReturnsResultSet) Then Response.Write("As " + GetRowClassCollectionName()) %>
			Dim <%= GetCamelCaseName(GetClassName()) %> As <%= GetClassName() %> = New <%= GetClassName() %>()
			
			'"Assign Property Values"
			<%= GetCamelCaseName(GetClassName()) %>.ConnectionString = connectionString
			<%= AssignPropertyValues(GetCamelCaseName(GetClassName())) %>
			'"End Assign Property Values"
			
			<% If (ReturnsResultSet) Then %>
			Dim <%= GetRowClassCollectionInstanceName() %> As <%= GetRowClassCollectionName() %> = <%= GetCamelCaseName(GetClassName()) %>.Execute()
			<% Else %>
			<%= GetCamelCaseName(GetClassName()) %>.Execute()
			<% End If %>
			
			'"Get Property Values"
			<%= GetPropertyValues(GetCamelCaseName(GetClassName())) %>
			'"End Get Property Values"
			<% If (ReturnsResultSet) Then %>
			
			Return <%= GetRowClassCollectionInstanceName() %>
			<% End If %>
		End <% If (ReturnsResultSet) Then Response.Write("Function") Else Response.Write("Sub") %>
		<% End If %>
		<% End If %>
        
		#End Region
	
    End Class
	
    #End Region
<% If (Not BatchMode) Then %>
End Namespace
<% End If %>

<script runat="template">

#Region "Name Helpers"

Public Function GetClassName() As String
	If Not(String.IsNullOrEmpty(CommandClassName)) Then
		Return CommandClassName
	Else If Not (SourceCommand is Nothing)
		Dim className As String = SourceCommand.Name
		If (className.StartsWith(Me.CommandPrefix)) Then
			className = className.Substring(Me.CommandPrefix.Length - 1)
		End If
		className = className.Replace(" ", "")
		className = className.Replace("_", "")
		Return className
	End If
    
        Return "WrapperClass"
End Function

Public Function GetRowClassName() As String

	If (ResultRowClassName <> Nothing AndAlso ResultRowClassName.Length > 0) Then
		Return ResultRowClassName
	Else
		Return GetClassName() & "Row"
	End If
End Function

Public Function GetRowClassCollectionName() As String
	Return "Collection( Of " + GetRowClassName() + ")"
End Function

Public Function GetRowClassCollectionInstanceName() As String
	Return GetCamelCaseName(GetRowClassName() + "List")
End Function

Public Shadows Function GetCamelCaseName(value As String) As String
	If (value.StartsWith("@")) Then value = value.Substring(1)
	If (value = "Return_VALUE") Then Return "ReturnValue"
	
	Return StringUtil.ToCamelCase(	value )
End Function

Public Function GetParameterName(value As String) As String
	value = value.Replace(" ", "")
	if (value.StartsWith("@")) Then value = value.Substring(1)
	Return "prm" + value
End Function

Public Shadows Function GetMemberVariableName(column As CommandResultColumnSchema) As String
	Dim propertyName As String = GetPropertyName(column)
	Dim memberVariableName As String = "_" + GetCamelCaseName(propertyName)
	
	Return memberVariableName
End Function

Public Shadows Function GetMemberVariableName(parameter As ParameterSchema) As String

	Dim propertyName As String = GetPropertyName(parameter)
	if (propertyName.StartsWith("@")) Then propertyName = propertyName.Substring(1)
	Dim memberVariableName As String = "_" + GetCamelCaseName(propertyName)
	
	Return memberVariableName
End Function

Public Shadows Function GetPropertyName(column As CommandResultColumnSchema) As String
	Dim propertyName As String = column.Name.Replace(" ", "")
	
	Return propertyName
End Function

Public Shadows Function GetPropertyName(parameter As ParameterSchema) As String
	Dim propertyName As String = parameter.Name.Replace(" ", "")
	if (propertyName.StartsWith("@")) Then propertyName = propertyName.Substring(1)
	
	Return propertyName
End Function
#End Region

#Region "Miscellaneous"

Public Overrides Function GetFileName() As String
	Return Me.GetClassName() + ".vb"
End Function

Private ReadOnly Property ReturnsResultSet As Boolean
	Get
		Try
			Return Me.ResultSchema <> ResultSchemaEnum.None AndAlso (SourceCommand.CommandResults.Count > 0)
		Catch
			' problem discovering schema information, change result schema to ADO.
			Me.ResultSchema = ResultSchemaEnum.ADO
			Return true
		End Try
	End Get
End Property

Public Sub BuildXmlCommentParameterList()

	Dim builder As System.Text.StringBuilder = New System.Text.StringBuilder()
	builder.Append(vbTab + vbTab + "' <param name=""connectionString"">The connection string to use</param>" + vbNewLine)
	
	For i As Int32 = 0 To (SourceCommand.InputParameters.Count - 1)
		builder.Append(vbTab + vbTab + " ")
		builder.Append("'<param name=""")
		builder.Append(GetCamelCaseName(SourceCommand.InputParameters(i).Name))
		builder.Append(""">")
		builder.Append(SourceCommand.InputParameters(i).Description)
		builder.Append("</param>" + vbNewLine)
	Next
	
	For i As Int32 = 0 To (SourceCommand.InputOutputParameters.Count - 1)
		builder.Append(vbTab + vbTab + " ")
		builder.Append("'<param name=""")
		builder.Append(GetCamelCaseName(SourceCommand.InputOutputParameters(i).Name))
		builder.Append(""">")
		builder.Append(SourceCommand.InputOutputParameters(i).Description)
		builder.Append("</param>" + vbNewLine)
	Next
	
	For i As Int32 = 0 To (SourceCommand.OutputParameters.Count - 1)
		builder.Append(vbTab + vbTab + " ")
		builder.Append("'<param name=""")
		builder.Append(GetCamelCaseName(SourceCommand.OutputParameters(i).Name))
		builder.Append(""">")
		builder.Append(SourceCommand.OutputParameters(i).Description)
		builder.Append("</param>" + vbNewLine)
	Next
	
	If (builder.ToString().Length > 0) Then
		Response.Write(builder.ToString())
	End If
End Sub

Public Sub BuildParameterExtraStatements(ByVal parameter As ParameterSchema)

	Dim builder As System.Text.StringBuilder = New System.Text.StringBuilder()
	Select Case (parameter.DataType)
		Case DbType.AnsiString, DbType.AnsiStringFixedLength, DbType.String, DbType.StringFixedLength
			builder.Append(vbTab + vbTab + vbTab + vbTab + vbTab)
			builder.Append(GetParameterName(parameter.Name))
			builder.Append(".Size = ")
			builder.Append(parameter.Size)
			builder.Append(vbNewLine)
		Case DbType.Currency,DbType.Decimal,DbType.Double,DbType.VarNumeric
			builder.Append(vbTab + vbTab + vbTab + vbTab + vbTab)
			builder.Append(GetParameterName(parameter.Name))
			builder.Append(".Precision = ")
			builder.Append(parameter.Precision)
			builder.Append(vbNewLine)
			builder.Append(vbTab + vbTab + vbTab + vbTab + vbTab)
			builder.Append(GetParameterName(parameter.Name))
			builder.Append(".Scale = ")
			builder.Append(parameter.Scale)
			builder.Append(vbNewLine)
	End Select
	
	If (builder.ToString().Length > 0) Then
		Response.Write(builder.ToString())
	End If
End Sub

Public Function BuildParameterList() As String
	Dim builder As System.Text.StringBuilder = New System.Text.StringBuilder()
	builder.Append("ByVal connectionString As String, ")
	For i As Int32 = 0 To (SourceCommand.InputParameters.Count - 1)
		builder.Append("ByVal " + GetCamelCaseName(SourceCommand.InputParameters(i).Name))
		builder.Append(" As ")
		builder.Append(GetNativeType(SourceCommand.InputParameters(i)))
		builder.Append(", ")
	Next
	For i As Int32 = 0 To (SourceCommand.InputOutputParameters.Count - 1)
		builder.Append("ByRef " + GetCamelCaseName(SourceCommand.InputOutputParameters(i).Name))
		builder.Append(" As ")
		builder.Append(GetNativeType(SourceCommand.InputOutputParameters(i)))
		builder.Append(", ")
	Next

	For i As Int32 = 0 To (SourceCommand.OutputParameters.Count - 1)
		builder.Append("ByRef " + GetCamelCaseName(SourceCommand.OutputParameters(i).Name))
		builder.Append("As ")
		builder.Append(GetNativeType(SourceCommand.OutputParameters(i)))
		builder.Append(", ")
	Next
	
	If (builder.ToString().Length > 0)
		Return builder.ToString().Substring(0, builder.Length - 2)
	Else
		Return String.Empty
	End If
End Function

Public Function BuildNullCheckStatement(ByVal parameter As ParameterSchema) As String

	If GetNativeType(parameter).EndsWith("()") Then
		Return String.Format("Not {0} Is Nothing", GetPropertyName(parameter))
	End If

	If GetNativeType(parameter).Equals("string", StringComparison.InvariantCultureIgnoreCase) Then
		Return String.Format("Not String.IsNullOrEmpty({0})", GetPropertyName(parameter))
	End If

	Return String.Format("{0}.HasValue", GetPropertyName(parameter))
End Function

Public Function BuildArgumentList() As String
	Dim builder As New System.Text.StringBuilder()
	Dim i As Integer = 0
	While i < SourceCommand.NonReturnValueParameters.Count
		builder.Append(SourceCommand.NonReturnValueParameters(i).Name)
		builder.Append(", ")
		System.Math.Max(System.Threading.Interlocked.Increment(i),i - 1)
	End While

	If builder.ToString().Length > 0 Then
		Return builder.ToString().Substring(0, builder.Length - 2)
	Else
		Return ""
	End If
End Function

' If the value type is a string then don't include the .Value.
Public Function BuildNullValueStatement(ByVal parameter As ParameterSchema) As String
	If GetNativeType(parameter).Equals("string", StringComparison.InvariantCultureIgnoreCase) OrElse GetNativeType(parameter).EndsWith("()") Then
		Return String.Empty
	End If

	Return ".Value"
End Function

Public Function GetNativeType(parameter As ParameterSchema) As String
	Dim result As String = Me.GetVBVariableType(parameter)
	If result.Equals("string", StringComparison.InvariantCultureIgnoreCase) OrElse result.EndsWith("()") Then
		Return result
	End If
    
	Return String.Format("Nullable(Of {0})", result)
End Function

Public Function GetNativeType(column As CommandResultColumnSchema) As String
	Dim result As String = Me.GetVBVariableType(column)
	If result.Equals("string", StringComparison.InvariantCultureIgnoreCase) OrElse result.EndsWith("()") Then
		Return result
	End If

	Return String.Format("Nullable(Of {0})", result)
End Function

Public Function AssignPropertyValues(objectName As String) As String

	Dim builder As System.Text.StringBuilder = New System.Text.StringBuilder()
	For i As Int32 = 0 To (SourceCommand.NonReturnValueParameters.Count - 1)
		builder.Append(objectName)
		builder.Append(".")
		builder.Append(GetPropertyName(SourceCommand.NonReturnValueParameters(i)))
		builder.Append(" = ")
		builder.Append(GetCamelCaseName(SourceCommand.NonReturnValueParameters(i).Name))
		builder.Append(vbNewLine + vbNewLine + vbTab + vbTab + vbTab)
	Next
	
	if (builder.ToString().Length > 0) Then
		Return builder.ToString().Substring(0, builder.Length - 7)
	Else
		Return String.Empty
	End If
End Function

Public Function GetPropertyValues(objectName As String) As String

	Dim builder As System.Text.StringBuilder = New System.Text.StringBuilder()
	For i As Int32 = 0 To (SourceCommand.AllOutputParameters.Count - 1)

		builder.Append(GetCamelCaseName(SourceCommand.AllOutputParameters(i).Name))
		builder.Append(" = ")
		builder.Append(objectName)
		builder.Append(".")
		builder.Append(GetPropertyName(SourceCommand.AllOutputParameters(i)))
		builder.Append(vbNewLine + vbNewLine + vbTab + vbTab + vbTab)

	Next
	
	If (builder.ToString().Length > 0) Then
		Return builder.ToString().Substring(0, builder.Length - 4)
	Else
		Return String.Empty
	End If
End Function

Public Function GetReturnValueDataType() As String
	If SourceCommand.Parameters.Contains("@RETURN_VALUE") AndAlso Not SourceCommand.Parameters("@RETURN_VALUE") Is Nothing Then
		Return SourceCommand.Parameters("@RETURN_VALUE").SystemType.ToString()
	End If

	Return "Integer"
End Function

#End Region

#Region "Declaration Statements"

Public Shadows Function GetMemberVariableDeclarationStatement(ByVal column As CommandResultColumnSchema) As String
	Return GetMemberVariableDeclarationStatement("Protected", column)
End Function

Public Shadows Function GetMemberVariableDeclarationStatement(ByVal protectionLevel As String, ByVal column As CommandResultColumnSchema) As String

	Dim statement As String = protectionLevel + " "
	statement += GetMemberVariableName(column) + " As " + GetNativeType(column)
	
	Dim DefaultValue As String = Nothing
	If Not (String.IsNullOrEmpty(DefaultValue)) Then
		statement += " = " + DefaultValue
	End If
	
	statement += ""
	
	Return statement
End Function

Public Shadows Function GetMemberVariableDeclarationStatement(ByVal parameter As ParameterSchema) As String
	Return GetMemberVariableDeclarationStatement("Protected", parameter)
End Function

Public Shadows Function GetMemberVariableDeclarationStatement(protectionLevel As String, parameter As ParameterSchema) As String

	Dim statement As String = protectionLevel + " "
	statement += GetMemberVariableName(parameter) + " As " + GetNativeType(parameter)
	
	Dim DefaultValue As String = Nothing
	If Not (String.IsNullOrEmpty(DefaultValue)) Then
		statement += " = " + DefaultValue
	End If
	
	statement += ""
	
	Return statement
End Function

Public Function GetReaderAssignmentStatement(ByVal column As CommandResultColumnSchema, ByVal index As Int32) As String

	Dim statement As String = "If (Not reader.IsDbNull(" + index.ToString() + ")) Then "
	statement += GetMemberVariableName(column) + " = "
	
	if (column.Name.EndsWith("TypeCode")) Then statement += "(" + column.Name + ")"
	
    Dim readerStatement as String = GetReaderMethod(column.DataType)
    If(readerStatement.Equals("GetBytes", StringComparison.InvariantCultureIgnoreCase)) Then
        statement += "GetBytes(reader, "" + column.Name + "")"
    Else
	    statement += "reader." + readerStatement + "(" + index.ToString() + ")"
    End If
	Return statement
End Function
#End Region

#Region "Lookups"

Public ReadOnly Property IsTableValuedFunction() As Boolean
	Get
		If SourceCommand Is Nothing OrElse Not SourceCommand.ExtendedProperties.Contains("CS_IsTableValuedFunction") Then
			Return False
		End If

		Dim temp As Boolean
		Boolean.TryParse(SourceCommand.ExtendedProperties("CS_IsTableValuedFunction").Value.ToString(), temp)

		Return temp
	End Get
End Property

Public Function GetAccessModifier() As String
    Select Case (Accessibility)
        Case AccessibilityEnum.Public
			Return "Public"
        Case AccessibilityEnum.Protected
			Return "Protected"
        Case AccessibilityEnum.Internal
			Return "internal"
        Case AccessibilityEnum.ProtectedInternal
			Return "Protected internal"
        Case AccessibilityEnum.Private
			Return "private"
        Case Else
			Return "Public"
    End Select
End Function

Public Enum ResultSchemaEnum
    StronglyTyped = 1
    ADO = 2
    None = 3
End Enum

Public Enum AccessibilityEnum
    [Public] = 1
    [Protected] = 2
    Internal = 3
    ProtectedInternal = 4
    [Private] = 5
End Enum

#End Region

</script>
